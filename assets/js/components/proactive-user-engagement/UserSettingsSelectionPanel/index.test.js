/**
 * UserSettingsSelectionPanel tests.
 *
 * Site Kit by Google, Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * Internal dependencies
 */

import {
	createTestRegistry,
	fireEvent,
	provideUserInfo,
	render,
} from '../../../../../tests/js/test-utils';
import { CORE_UI } from '@/js/googlesitekit/datastore/ui/constants';
import { USER_SETTINGS_SELECTION_PANEL_OPENED_KEY } from '@/js/components/proactive-user-engagement/constants';
import {
	VIEW_CONTEXT_MAIN_DASHBOARD,
	VIEW_CONTEXT_MAIN_DASHBOARD_VIEW_ONLY,
} from '@/js/googlesitekit/constants';
import UserSettingsSelectionPanel from '@/js/components/proactive-user-engagement/UserSettingsSelectionPanel';
import SelectionPanelFooter from '@/js/components/proactive-user-engagement/UserSettingsSelectionPanel/SelectionPanelFooter';

describe( 'UserSettingsSelectionPanel', () => {
	const features = [ 'proactiveUserEngagement' ];
	let registry;

	beforeEach( () => {
		registry = createTestRegistry();

		provideUserInfo( registry, { email: 'someone@anybusiness.com' } );

		registry
			.dispatch( CORE_UI )
			.setValue( USER_SETTINGS_SELECTION_PANEL_OPENED_KEY, true );
	} );

	it( 'renders header subheading in admin view', () => {
		const { getByText } = render( <UserSettingsSelectionPanel />, {
			registry,
			features,
			viewContext: VIEW_CONTEXT_MAIN_DASHBOARD,
		} );

		const heading = getByText( 'Email reports subscription' );
		expect( heading ).toBeInTheDocument();

		const headerEl = heading.closest( 'header' );
		expect( headerEl ).toBeInTheDocument();

		expect(
			getByText( 'You can always deactivate this feature in', {
				exact: false,
			} )
		).toBeInTheDocument();
	} );

	it( 'does not render header subheading in view-only', () => {
		provideUserInfo( registry, { email: 'viewer@example.com' } );

		const { getByText, queryByText } = render(
			<UserSettingsSelectionPanel />,
			{
				registry,
				features,
				viewContext: VIEW_CONTEXT_MAIN_DASHBOARD_VIEW_ONLY,
			}
		);

		expect( getByText( 'Email reports subscription' ) ).toBeInTheDocument();

		expect(
			queryByText( /you can always deactivate this feature in/i )
		).not.toBeInTheDocument();
	} );

	it( 'displays the user email in the explanatory copy when available', () => {
		const { getByText } = render( <UserSettingsSelectionPanel />, {
			registry,
			features,
			viewContext: VIEW_CONTEXT_MAIN_DASHBOARD,
		} );

		expect(
			getByText(
				"You'll receive the report to your WordPress user email",
				{ exact: false }
			)
		).toBeInTheDocument();
		expect( getByText( 'someone@anybusiness.com' ) ).toBeInTheDocument();
	} );

	it( 'opens the side sheet when the UI key is true', () => {
		provideUserInfo( registry, { email: 'open@example.com' } );

		const { getByRole } = render( <UserSettingsSelectionPanel />, {
			registry,
			features,
			viewContext: VIEW_CONTEXT_MAIN_DASHBOARD,
		} );

		const dialog = getByRole( 'dialog' );
		expect( dialog ).toHaveAttribute( 'aria-hidden', 'false' );
	} );
} );

describe( 'Footer', () => {
	it( 'renders default description when no notice is provided', () => {
		const { getByText } = render( <SelectionPanelFooter /> );

		expect(
			getByText(
				'This email is generated by Site Kit using data from your dashboard and sent to your WordPress email, so all your data stays with you'
			)
		).toBeInTheDocument();
	} );

	it( 'renders a notice with dismiss button when notice prop is provided', () => {
		const onDismiss = jest.fn();
		const { getByText, getByRole } = render(
			<SelectionPanelFooter
				notice={ { type: 'error', text: 'There was a problem.' } }
				onNoticeDismiss={ onDismiss }
			/>
		);

		expect( getByText( 'There was a problem.' ) ).toBeInTheDocument();

		const dismissButton = getByRole( 'button', { name: 'Got it' } );
		fireEvent.click( dismissButton );

		expect( onDismiss ).toHaveBeenCalled();
	} );
} );
